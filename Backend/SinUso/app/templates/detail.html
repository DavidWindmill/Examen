<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ calendario.titulo }} - Kalendas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/theme-green.css">
    <link rel="stylesheet" href="/static/css/theme-pink.css">
</head>

<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <a href="{{ back_url }}" class="back-link">‚Üê Volver a Calendarios</a>
            <div class="theme-selector">
                <label for="theme-select">Tema:</label>
                <select id="theme-select" onchange="changeTheme(this.value)">
                    <option value="green">Verde Moco</option>
                    <option value="pink">Rosa Pastel</option>
                </select>
            </div>
        </div>

        <h1>{{ calendario.titulo }}</h1>

        <div class="detail-container">
            <div class="calendar-info">
                <div class="info-section">
                    <div class="info-label">T√≠tulo</div>
                    {% if is_owner %}
                    <div class="editable-title">
                        <div class="info-value" id="titulo-display">{{ calendario.titulo }}</div>
                        <button class="edit-btn" onclick="editTitle()">Editar</button>
                    </div>
                    <form method="POST" action="/calendario/{{ calendario._id }}/update-title" id="titulo-form"
                        style="display: none;">
                        <div class="form-group">
                            <input type="text" name="titulo" id="titulo-input" value="{{ calendario.titulo }}" required>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button type="submit" class="btn btn-primary">Guardar</button>
                            <button type="button" class="btn btn-secondary"
                                onclick="cancelEditTitle()">Cancelar</button>
                        </div>
                    </form>
                    {% else %}
                    <div class="info-value">{{ calendario.titulo }}</div>
                    {% endif %}
                </div>

                <div class="info-section">
                    <div class="info-label">Organizador</div>
                    <div class="info-value">{{ calendario.organizador }}</div>
                </div>

                <div class="info-section">
                    <div class="info-label">Etiquetas</div>
                    <div class="tags">
                        {% if calendario.palabras_claves %}
                        {% for tag in calendario.palabras_claves %}
                        <span class="tag">
                            {{ tag }}
                            {% if is_owner %}
                            <form method="POST" action="/calendario/{{ calendario._id }}/remove-tag"
                                style="display: inline;">
                                <input type="hidden" name="tag" value="{{ tag }}">
                                <button type="submit" class="remove-tag" title="Eliminar etiqueta">√ó</button>
                            </form>
                            {% endif %}
                        </span>
                        {% endfor %}
                        {% endif %}
                    </div>
                    {% if is_owner %}
                    <form method="POST" action="/calendario/{{ calendario._id }}/add-tag" class="add-tag-form">
                        <input type="text" name="tag" placeholder="Nueva etiqueta" required>
                        <button type="submit">A√±adir</button>
                    </form>
                    {% endif %}
                </div>

                <!-- Secci√≥n de estad√≠sticas -->
                <div class="info-section">
                    <div class="info-label">Estad√≠sticas</div>
                    <div class="stats-container">
                        <div class="stat-item">
                            <div class="stat-value" id="cantidad-eventos">‚è≥</div>
                            <div class="stat-label">Total de Eventos</div>
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n de pr√≥ximos eventos -->
                <div class="info-section">
                    <div class="info-label">Pr√≥ximos Eventos</div>
                    <div id="proximos-eventos" class="proximos-eventos-list">
                        <!-- Los pr√≥ximos eventos se cargar√°n aqu√≠ -->
                    </div>
                </div>
            </div>

            {% include "bloque_calendario.html" %}

        </div>

    </div>

    </div>

    <script>
        function editTitle() {
            document.getElementById('titulo-display').parentElement.style.display = 'none';
            document.getElementById('titulo-form').style.display = 'block';
            document.getElementById('titulo-input').focus();
        }

        function cancelEditTitle() {
            document.getElementById('titulo-display').parentElement.style.display = 'flex';
            document.getElementById('titulo-form').style.display = 'none';
        }

        // Theme management
        function changeTheme(theme) {
            document.body.className = theme === 'pink' ? 'theme-pink' : '';
            localStorage.setItem('kalendas-theme', theme);
        }

        // Load saved theme on page load
        window.addEventListener('DOMContentLoaded', function () {
            const savedTheme = localStorage.getItem('kalendas-theme') || 'green';
            document.getElementById('theme-select').value = savedTheme;
            if (savedTheme === 'pink') {
                document.body.classList.add('theme-pink');
            }

            // Cargar datos del calendario
            cargarEstadisticas();
            cargarProximosEventos();
        });

        // Image management
        const calendarioId = '{{ calendario._id }}';

        // Cargar estad√≠sticas del calendario
        async function cargarEstadisticas() {
            try {
                const response = await fetch(`/calendario/${calendarioId}/cantidad-eventos`);
                const data = await response.json();

                if (data.cantidad_eventos !== undefined) {
                    document.getElementById('cantidad-eventos').textContent = data.cantidad_eventos;
                } else {
                    document.getElementById('cantidad-eventos').textContent = '0';
                }
            } catch (error) {
                console.error('Error al cargar estad√≠sticas:', error);
                document.getElementById('cantidad-eventos').textContent = 'Error';
            }
        }

        // Cargar pr√≥ximos eventos
        async function cargarProximosEventos() {
            try {
                const response = await fetch(`/calendario/${calendarioId}/proximos-eventos?limite=5`);
                const data = await response.json();

                const container = document.getElementById('proximos-eventos');
                container.innerHTML = '';

                if (data.proximos_eventos && data.proximos_eventos.length > 0) {
                    data.proximos_eventos.forEach(evento => {
                        const eventoDiv = document.createElement('div');
                        eventoDiv.className = 'proximo-evento-item';

                        // Formatear fechas
                        const inicio = new Date(evento.hora_comienzo);
                        const fin = new Date(evento.hora_fin);
                        const fechaInicio = inicio.toLocaleDateString('es-ES', {
                            day: 'numeric',
                            month: 'short',
                            year: 'numeric'
                        });
                        const horaInicio = inicio.toLocaleTimeString('es-ES', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        const horaFin = fin.toLocaleTimeString('es-ES', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });

                        eventoDiv.innerHTML = `
                            <div class="evento-titulo">${evento.titulo}</div>
                            <div class="evento-fecha">üìÖ ${fechaInicio}</div>
                            <div class="evento-hora">‚è∞ ${horaInicio} - ${horaFin}</div>
                            ${evento.descripcion ? `<div class="evento-descripcion">${evento.descripcion}</div>` : ''}
                        `;

                        container.appendChild(eventoDiv);
                    });
                } else {
                    container.innerHTML = '<p class="no-eventos">No hay eventos pr√≥ximos</p>';
                }
            } catch (error) {
                console.error('Error al cargar pr√≥ximos eventos:', error);
                document.getElementById('proximos-eventos').innerHTML = '<p class="error-message">Error al cargar eventos</p>';
            }
        }
    </script>
</body>

</html>