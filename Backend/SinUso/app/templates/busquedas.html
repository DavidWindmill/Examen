{% extends "base.html" %}
{% block content %}

<div class="busquedas-shell">
  <div class="search-hero">
    <div class="breadcrumb">
      <span class="crumb">Home</span>
      <span class="separator">/</span>
      <span class="crumb active">Buscar</span>
    </div>
    <div class="search-bar">
      <input id="inputBusqueda" type="text" placeholder="Buscar por titulo de evento o calendario..." aria-label="Buscar" />
      <button id="btnBuscar" type="button">Buscar</button>
    </div>
    <p class="hint">Filtra por organizador/creador, fechas o limita los eventos a ciertos calendarios.</p>
  </div>

  <div class="layout">
    <aside class="filters">
      <h5>Filtros</h5>

      <label for="fOrganizador">Organizador / Creador</label>
      <input id="fOrganizador" type="text" placeholder="Nombre o id" />

      <div class="filter-grid">
        <div>
          <label for="fDesde">Fecha desde (eventos)</label>
          <input id="fDesde" type="date" />
        </div>
        <div>
          <label for="fHasta">Fecha hasta (eventos)</label>
          <input id="fHasta" type="date" />
        </div>
      </div>

      <label>Calendarios (aplica a eventos)</label>
      <div id="fCalendarios" class="cal-checks">
        {% for c in calendarios %}
        <label class="chk">
          <input type="checkbox" name="calCheck" value="{{ c['_id'] }}">
          <span>{{ c['titulo'] }}</span>
        </label>
        {% endfor %}
      </div>

      <div class="filter-actions">
        <button id="btnAplicarFiltros" type="button">Aplicar filtros</button>
        <button id="btnLimpiar" type="button" class="ghost">Limpiar</button>
      </div>

      <div id="estadoBusqueda" class="estado"></div>
    </aside>

    <main class="results">
      <section class="card">
        <header class="card-head">
          <div>
            <p class="eyebrow">Calendarios</p>
            <h4>Resultados de calendarios</h4>
          </div>
          <span id="badgeCalendarios" class="pill"></span>
        </header>
        <div id="listaCalendarios" class="list-grid"></div>
      </section>

      <section class="card">
        <header class="card-head">
          <div>
            <p class="eyebrow">Eventos</p>
            <h4>Resultados de eventos</h4>
          </div>
          <span id="badgeEventos" class="pill"></span>
        </header>
        <div id="listaEventos" class="list-grid"></div>
      </section>
    </main>
  </div>
</div>

<style>
  .busquedas-shell {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px 20px 40px;
  }

  .breadcrumb {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #637081;
    font-size: 14px;
  }

  .crumb.active {
    color: #1a2b44;
    font-weight: 600;
  }

  .search-hero {
    background: linear-gradient(120deg, #eef5ff, #f9fbff);
    border: 1px solid #e4ebf5;
    padding: 18px;
    border-radius: 14px;
    box-shadow: 0 6px 18px rgba(17, 38, 74, 0.06);
  }

  .search-bar {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-top: 10px;
  }

  .search-bar input {
    flex: 1;
    border: 1px solid #cfd7e5;
    border-radius: 12px;
    padding: 12px 14px;
    font-size: 15px;
    outline: none;
    transition: border 0.2s ease, box-shadow 0.2s ease;
  }

  .search-bar input:focus {
    border-color: #2f6fed;
    box-shadow: 0 0 0 3px rgba(47, 111, 237, 0.12);
  }

  .search-bar button {
    border: none;
    background: #2f6fed;
    color: white;
    padding: 12px 18px;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
  }

  .search-bar button:hover {
    background: #255ccc;
  }

  .hint {
    margin: 8px 0 0;
    color: #6b7a90;
    font-size: 14px;
  }

  .layout {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 16px;
    margin-top: 18px;
  }

  .filters {
    background: #ffffff;
    border: 1px solid #e6ebf2;
    border-radius: 14px;
    padding: 16px;
    box-shadow: 0 8px 18px rgba(17, 38, 74, 0.04);
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .filters h5 {
    margin: 0;
    color: #1f2f46;
  }

  .filters label {
    font-size: 14px;
    color: #4b5a71;
    margin-bottom: 4px;
    display: block;
  }

  .filters input,
  .filters select {
    width: 100%;
    border: 1px solid #cfd7e5;
    border-radius: 10px;
    padding: 10px;
    font-size: 14px;
    outline: none;
  }

  .filters input:focus,
  .filters select:focus {
    border-color: #2f6fed;
    box-shadow: 0 0 0 3px rgba(47, 111, 237, 0.12);
  }

  .cal-checks {
    display: flex;
    flex-direction: column;
    gap: 6px;
    max-height: 220px;
    overflow: auto;
    border: 1px solid #cfd7e5;
    border-radius: 10px;
    padding: 8px;
  }

  .chk {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: #2f3d52;
  }

  .filter-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
  }

  .filter-actions {
    display: flex;
    gap: 8px;
    margin-top: 6px;
  }

  .filters button {
    flex: 1;
    border: none;
    padding: 10px 12px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
  }

  .filters button:hover {
    filter: brightness(0.97);
  }

  .filters button.ghost {
    background: #f3f6fb;
    color: #2f3d52;
    border: 1px solid #d5deea;
  }

  .estado {
    margin-top: 6px;
    color: #d06a00;
    font-size: 13px;
    min-height: 18px;
  }

  .results {
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .card {
    background: #ffffff;
    border: 1px solid #e6ebf2;
    border-radius: 14px;
    padding: 14px;
    box-shadow: 0 8px 18px rgba(17, 38, 74, 0.05);
  }

  .card-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
  }

  .eyebrow {
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 11px;
    color: #6c7b90;
    margin: 0;
  }

  .card h4 {
    margin: 4px 0 0;
    color: #1b283c;
  }

  .pill {
    background: #eef2fb;
    color: #2f3f66;
    border-radius: 999px;
    padding: 6px 10px;
    font-size: 12px;
    min-width: 42px;
    text-align: center;
  }

  .list-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 10px;
  }

  .item {
    border: 1px solid #e4e8f1;
    border-radius: 10px;
    padding: 12px;
    background: #fdfefe;
  }

  .item h5 {
    margin: 0 0 6px;
    color: #1d2b3f;
  }

  .item p {
    margin: 0 0 4px;
    color: #4e5c71;
    font-size: 14px;
  }

  .empty {
    color: #74839a;
    font-size: 14px;
  }

  @media (max-width: 960px) {
    .layout {
      grid-template-columns: 1fr;
    }
    .filter-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const refs = {
    query: document.getElementById("inputBusqueda"),
    organizador: document.getElementById("fOrganizador"),
    desde: document.getElementById("fDesde"),
    hasta: document.getElementById("fHasta"),
    calendarios: document.getElementById("fCalendarios"),
    btnBuscar: document.getElementById("btnBuscar"),
    btnAplicar: document.getElementById("btnAplicarFiltros"),
    btnLimpiar: document.getElementById("btnLimpiar"),
    listaCalendarios: document.getElementById("listaCalendarios"),
    listaEventos: document.getElementById("listaEventos"),
    badgeCalendarios: document.getElementById("badgeCalendarios"),
    badgeEventos: document.getElementById("badgeEventos"),
    estado: document.getElementById("estadoBusqueda"),
  };

  const debounce = (fn, delay = 300) => {
    let timer;
    return (...args) => {
      clearTimeout(timer);
      timer = setTimeout(() => fn(...args), delay);
    };
  };

  const buildParams = () => {
    const params = new URLSearchParams();
    const q = refs.query.value.trim();
    if (q) params.append("query", q);
    const org = refs.organizador.value.trim();
    if (org) params.append("organizador", org);
    if (refs.desde.value) params.append("desde", refs.desde.value);
    if (refs.hasta.value) params.append("hasta", refs.hasta.value);

    // Calendarios seleccionados via checkboxes
    const checks = refs.calendarios.querySelectorAll('input[name="calCheck"]:checked');
    checks.forEach((chk) => {
      if (chk.value) params.append("calendarios", chk.value);
    });

    return params;
  };

  const pintarCalendarios = (lista) => {
    refs.listaCalendarios.innerHTML = "";
    refs.badgeCalendarios.textContent = Array.isArray(lista) ? lista.length : 0;
    if (!lista || lista.length === 0) {
      refs.listaCalendarios.innerHTML = "<p class='empty'>No se encontraron calendarios.</p>";
      return;
    }
    lista.forEach((cal) => {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <h5>${cal.titulo || "Sin titulo"}</h5>
        <p><strong>Creador:</strong> ${cal.organizador || "N/D"}</p>
        <p><strong>Tags:</strong> ${(cal.palabras_clave || cal.palabras_claves || []).join(", ") || "N/D"}</p>
      `;
      refs.listaCalendarios.appendChild(div);
    });
  };

  const pintarEventos = (lista) => {
    refs.listaEventos.innerHTML = "";
    refs.badgeEventos.textContent = Array.isArray(lista) ? lista.length : 0;
    if (!lista || lista.length === 0) {
      refs.listaEventos.innerHTML = "<p class='empty'>No se encontraron eventos.</p>";
      return;
    }
    lista.forEach((ev) => {
      const div = document.createElement("div");
      div.className = "item";
      const fechaInicio = ev.hora_comienzo ? new Date(ev.hora_comienzo).toLocaleString() : "N/D";
      const fechaFin = ev.hora_fin ? new Date(ev.hora_fin).toLocaleString() : "N/D";
      div.innerHTML = `
        <h5>${ev.titulo || "Sin titulo"}</h5>
        <p><strong>Organizador:</strong> ${ev.organizador || "N/D"}</p>
        <p><strong>Inicio:</strong> ${fechaInicio}</p>
        <p><strong>Fin:</strong> ${fechaFin}</p>
      `;
      refs.listaEventos.appendChild(div);
    });
  };

  const ejecutarBusqueda = async () => {
    const params = buildParams();
    // Si no hay ningún filtro, no disparamos llamadas innecesarias
    if ([...params.keys()].length === 0) {
      refs.estado.textContent = "Introduce un término o ajusta filtros para buscar.";
      pintarCalendarios([]);
      pintarEventos([]);
      return;
    }

    refs.estado.textContent = "Buscando...";
    try {
      const res = await fetch(`/evento/global_v2?${params.toString()}`);
      if (!res.ok) throw new Error(`Error ${res.status}`);
      const data = await res.json();
      pintarCalendarios(data.calendarios || []);
      pintarEventos(data.eventos || []);
      refs.estado.textContent = "";
    } catch (err) {
      refs.estado.textContent = "No se pudo completar la busqueda (revisa filtros o vuelve a intentar).";
      pintarCalendarios([]);
      pintarEventos([]);
      console.error("Error en la busqueda global:", err);
    }
  };

  const ejecutarBusquedaDebounced = debounce(ejecutarBusqueda, 350);

  refs.query.addEventListener("input", ejecutarBusquedaDebounced);
  refs.organizador.addEventListener("input", ejecutarBusquedaDebounced);
  refs.desde.addEventListener("change", ejecutarBusquedaDebounced);
  refs.hasta.addEventListener("change", ejecutarBusquedaDebounced);
  refs.calendarios.addEventListener("change", ejecutarBusquedaDebounced);
  refs.btnBuscar.addEventListener("click", ejecutarBusqueda);
  refs.btnAplicar.addEventListener("click", ejecutarBusqueda);
  refs.btnLimpiar.addEventListener("click", () => {
    refs.query.value = "";
    refs.organizador.value = "";
    refs.desde.value = "";
    refs.hasta.value = "";
    refs.calendarios.querySelectorAll('input[name="calCheck"]').forEach((chk) => (chk.checked = false));
    ejecutarBusqueda();
  });

  // No hacemos búsqueda inicial para evitar listar todo sin filtros
});
</script>

{% endblock %}
