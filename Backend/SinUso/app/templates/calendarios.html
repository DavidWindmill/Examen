{% extends "base.html" %}

{% block content %}

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1>Kalendas</h1>
            <p>Sistema de gesti√≥n de calendarios y eventos</p>
        </div>

        <div style="display: flex; flex-direction: column; gap: 10px; align-items: flex-end;">
            <!-- BUSCADOR -->
            <form method="GET" action="/calendarios" class="d-flex">
                <input type="text" name="q" placeholder="Buscar calendarios..."
                       value="{{ search_query }}" class="form-control me-2">
                <button type="submit" class="btn btn-primary">üîç</button>
            </form>
        </div>
    </div>

    {% if is_searching %}
    <div class="alert alert-info d-flex justify-content-between align-items-center">
        <span>Resultados de b√∫squeda para: <b>{{ search_query }}</b> ({{ calendarios|length }} encontrados)</span>
        <a href="/calendarios" class="btn btn-outline-secondary">‚Üê Volver</a>
    </div>
    {% endif %}

    <h2 class="mb-3">Calendarios Disponibles</h2>

    <div class="row g-3">

        {% if is_owner and not is_searching %}
        <!-- Crear calendario -->
        <div class="col-6 col-md-4 col-lg-3">
            <div class="border rounded d-flex justify-content-center align-items-center"
                 style="height: 180px; cursor: pointer;" onclick="openCreateModal()">
                <span style="font-size: 42px;">+</span>
            </div>
        </div>
        {% endif %}

        {% for calendario in calendarios %}
        <div class="col-6 col-md-4 col-lg-3">

            <a href="/calendario/{{ calendario._id }}{% if search_query %}?q={{ search_query }}{% endif %}"
               class="text-decoration-none">

                <div class="border rounded p-2 calendar-card position-relative">

                    {% if is_owner %}
                    <!-- Botones de acci√≥n -->
                    <div style="position: absolute; right: 8px; top: 8px; display: flex; gap: 5px; z-index: 10;">
                        <button class="btn btn-sm btn-warning" style="padding: 2px 6px; font-size: 12px;"
                                onclick="openEditModal('{{ calendario._id }}', '{{ calendario.titulo }}', '{{ calendario.organizador }}'); event.preventDefault(); event.stopPropagation();">
                            ‚úèÔ∏è
                        </button>
                        <button class="btn btn-sm btn-danger" style="padding: 2px 6px; font-size: 12px;"
                                onclick="eliminarCalendario('{{ calendario._id }}', '{{ calendario.titulo }}'); event.preventDefault(); event.stopPropagation();">
                            √ó
                        </button>
                    </div>
                    {% endif %}

                    <h5 class="text-center" style="padding-right: 60px;">{{ calendario.titulo }}</h5>

                    <!-- MINI CALENDARIO -->
                    <div class="text-center small mt-2">
                        {{ current_month }} {{ current_year }}
                    </div>

                    <div class="calendar-weekdays d-flex justify-content-between mt-1">
                        <span>L</span><span>M</span><span>X</span><span>J</span>
                        <span>V</span><span>S</span><span>D</span>
                    </div>

                    <div class="calendar-days d-grid"
                        style="grid-template-columns: repeat(7, 1fr); gap: 2px;">

                        {# mes_matriz es una lista de semanas, cada semana es [1,2,3,...] o 0 si no hay d√≠a #}

                        {% for semana in mes_matriz %}
                            {% for dia in semana %}
                                {% if dia == 0 %}
                                    <div class="border rounded small text-center text-muted" style="opacity:0.4;">
                                        -
                                    </div>
                                {% else %}
                                    <div class="border rounded small text-center">
                                        {{ dia }}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% endfor %}

                    </div>

                </div>

            </a>

        </div>
        {% endfor %}
    </div>
</div>

<!-- MODAL CREAR CALENDARIO -->
<div id="createModal" class="modal">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Crear Nuevo Calendario</h5>
                <button type="button" class="btn-close" onclick="closeCreateModal()"></button>
            </div>

            <form method="POST" action="/calendario/crear">
                <div class="modal-body">
                    <label class="form-label">T√≠tulo</label>
                    <input type="text" name="titulo" class="form-control" required>

                    <label class="form-label mt-3">Organizador</label>
                    <input type="text" name="organizador" class="form-control" required>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" type="button" onclick="closeCreateModal()">Cancelar</button>
                    <button class="btn btn-primary" type="submit">Crear</button>
                </div>
            </form>

        </div>
    </div>
</div>

<!-- MODAL EDITAR CALENDARIO -->
<div id="editModal" class="modal">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Editar Calendario</h5>
                <button type="button" class="btn-close" onclick="closeEditModal()"></button>
            </div>

            <form id="editForm" onsubmit="submitEditForm(event)">
                <input type="hidden" id="edit-calendario-id">
                <div class="modal-body">
                    <label class="form-label">T√≠tulo</label>
                    <input type="text" name="titulo" id="edit-titulo" class="form-control" required>

                    <label class="form-label mt-3">Organizador</label>
                    <input type="text" name="organizador" id="edit-organizador" class="form-control" required>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" type="button" onclick="closeEditModal()">Cancelar</button>
                    <button class="btn btn-primary" type="submit">Guardar Cambios</button>
                </div>
            </form>

        </div>
    </div>
</div>

<script>
function openCreateModal() {
    const modal = document.getElementById('createModal');
    modal.style.display = 'flex';
}

function closeCreateModal() {
    const modal = document.getElementById('createModal');
    modal.style.display = 'none';
}

function openEditModal(calendarioId, titulo, organizador) {
    document.getElementById('edit-calendario-id').value = calendarioId;
    document.getElementById('edit-titulo').value = titulo;
    document.getElementById('edit-organizador').value = organizador;
    
    const modal = document.getElementById('editModal');
    modal.style.display = 'flex';
}

function closeEditModal() {
    const modal = document.getElementById('editModal');
    modal.style.display = 'none';
}

// Funci√≥n para editar calendario usando PUT
async function submitEditForm(event) {
    event.preventDefault();
    
    const calendarioId = document.getElementById('edit-calendario-id').value;
    const titulo = document.getElementById('edit-titulo').value;
    const organizador = document.getElementById('edit-organizador').value;
    
    const formData = new FormData();
    formData.append('titulo', titulo);
    formData.append('organizador', organizador);
    
    try {
        const response = await fetch(`/calendario/${calendarioId}`, {
            method: 'PUT',
            body: formData
        });
        
        if (response.ok) {
            closeEditModal();
            window.location.reload();
        } else {
            const error = await response.json();
            alert('Error al actualizar: ' + (error.detail || 'Error desconocido'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al actualizar el calendario');
    }
}

// Funci√≥n para eliminar calendario usando DELETE
async function eliminarCalendario(calendarioId, titulo) {
    if (!confirm(`¬øEliminar el calendario '${titulo}'?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/calendario/${calendarioId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            const error = await response.json();
            alert('Error al eliminar: ' + (error.detail || 'Error desconocido'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al eliminar el calendario');
    }
}

// Cerrar modales al hacer clic fuera de ellos
window.onclick = function(event) {
    const createModal = document.getElementById('createModal');
    const editModal = document.getElementById('editModal');
    
    if (event.target == createModal) {
        closeCreateModal();
    }
    if (event.target == editModal) {
        closeEditModal();
    }
}

// Cerrar modales con la tecla Escape
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeCreateModal();
        closeEditModal();
    }
});

function changeTheme(theme) {
    document.body.className = theme === 'pink' ? 'theme-pink' : '';
    localStorage.setItem('kalendas-theme', theme);
}

window.addEventListener('DOMContentLoaded', () => {
    const saved = localStorage.getItem('kalendas-theme') || 'green';
    document.getElementById('theme-select').value = saved;
    if (saved === 'pink') document.body.classList.add('theme-pink');
});
</script>

{% endblock %}
