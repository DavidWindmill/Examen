<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mapa</title>

  <!-- Leaflet (OpenStreetMap) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    header {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 12px;
      padding: 12px 16px;
      border-bottom: 1px solid #e6e6e6;
    }
    .user {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-right: 6px;
    }
    #userAvatar {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      display: none;
    }
    button {
      cursor: pointer;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: white;
    }
    #btnLogout { display: none; }
    main { padding: 16px; }
    #status { font-size: 14px; opacity: .8; }
    #map { height: 520px; border-radius: 16px; border: 1px solid #e6e6e6; }
    .panel {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin: 12px 0 16px;
    }
    input {
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 10px;
      min-width: 260px;
    }
    .hint { font-size: 13px; opacity: 0.8; }
  </style>

  <!-- Firebase Auth + UI -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    // ✅ Tu firebaseConfig (frontend). ApiKey pública OK.
    const firebaseConfig = {
      apiKey: "AIzaSyBXe0ayyeP0XbOuJsf7HeHNP7bxiJMc4oo",
      authDomain: "examen-6569c.firebaseapp.com",
      projectId: "examen-6569c",
      storageBucket: "examen-6569c.firebasestorage.app",
      messagingSenderId: "805253871320",
      appId: "1:805253871320:web:5153beecec7b93f14e49ad",
      measurementId: "G-MYQ235TXFC"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const $ = (id) => document.getElementById(id);

    let map;
    let markersLayer;

    async function callBackendMe(idToken) {
      const res = await fetch("/api/me", {
        headers: { Authorization: `Bearer ${idToken}` }
      });
      return res.json();
    }

    async function apiFetch(path, options = {}) {
      const token = localStorage.getItem("token");
      if (!token) throw new Error("No hay token");

      const headers = {
        ...(options.headers || {}),
        Authorization: `Bearer ${token}`
      };

      return fetch(path, { ...options, headers });
    }

    function ensureMap() {
      if (map) return;

      map = L.map('map').setView([20, 0], 2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap'
      }).addTo(map);

      markersLayer = L.layerGroup().addTo(map);
    }

    async function refreshMarkers() {
      ensureMap();
      markersLayer.clearLayers();

      const res = await apiFetch("/api/locations");
      if (!res.ok) {
        const txt = await res.text();
        throw new Error(txt);
      }

      const data = await res.json();
      const bounds = [];

      data.forEach(loc => {
        bounds.push([loc.lat, loc.lon]);
        const m = L.marker([loc.lat, loc.lon]).addTo(markersLayer);

        const imgHtml = loc.image_url
          ? `<br/>
            <img src="${escapeHtml(loc.image_url)}"
                  style="width:180px;max-width:100%;border-radius:12px;margin-top:8px;" />`
          : "";

        m.bindPopup(
          `<b>${escapeHtml(loc.name)}</b>
          ${imgHtml}
          <br/>
          <button data-del="${loc._id}">Eliminar</button>`
        );

        m.on("popupopen", (e) => {
          const btn = e.popup.getElement()?.querySelector("button[data-del]");
          if (!btn) return;
          btn.addEventListener("click", async () => {
            try {
              await apiFetch(`/api/locations/${btn.getAttribute("data-del")}`, {
                method: "DELETE"
              });
              await refreshMarkers();
            } catch (err) {
              console.error(err);
              alert("No se pudo eliminar el marcador");
            }
          });
        });
      });

      if (bounds.length) {
        map.fitBounds(bounds, { padding: [30, 30] });
      }

      renderGallery(data);
    }

    function renderGallery(locations) {
      const g = document.getElementById("gallery");
      if (!g) return;

      g.innerHTML = "";

      locations
        .filter(l => l.image_url)
        .forEach(l => {
          const img = document.createElement("img");
          img.src = l.image_url;
          img.alt = l.name;
          img.style.height = "110px";
          img.style.borderRadius = "12px";
          img.style.border = "1px solid #e6e6e6";
          g.appendChild(img);
        });
    }

    async function addPlace(place, file) {
      const fd = new FormData();
      fd.append("place", place);
      if (file) fd.append("image", file);

      const res = await apiFetch("/api/locations", {
        method: "POST",
        body: fd
      });

      if (!res.ok) {
        const txt = await res.text();
        throw new Error(txt);
      }
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    async function renderUser(user) {
      const avatar = $("userAvatar");
      const name = $("userName");
      const status = $("status");
      const btnLogin = $("btnLogin");
      const btnLogout = $("btnLogout");

      if (!user) {
        localStorage.removeItem("token");
        avatar.style.display = "none";
        avatar.src = "";
        name.textContent = "No autenticado";
        status.textContent = "";
        btnLogin.style.display = "inline-flex";
        btnLogout.style.display = "none";
        return;
      }

      avatar.style.display = "inline-block";
      avatar.src = user.photoURL || "";
      name.textContent = user.displayName || user.email || "Usuario";
      btnLogin.style.display = "none";
      btnLogout.style.display = "inline-flex";

      try {
        const idToken = await user.getIdToken();
        localStorage.setItem("token", idToken);
        const me = await callBackendMe(idToken);
        status.textContent = `Backend OK: UID=${me.uid || "?"} Email=${me.email || "?"}`;

        // Cargar mapa y marcadores del usuario
        await refreshMarkers();
      } catch (e) {
        console.error(e);
        status.textContent = "Backend: no se pudo verificar el token (revisa /api/me y Firebase Admin).";
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      $("btnLogin").addEventListener("click", async () => {
        try {
          await signInWithPopup(auth, provider);
        } catch (e) {
          console.error("Login error:", e);
          alert("Error al iniciar sesión con Google. Revisa Authorized domains en Firebase.");
        }
      });

      $("btnLogout").addEventListener("click", async () => {
        try {
          await signOut(auth);
          localStorage.removeItem("token");
        } catch (e) {
          console.error("Logout error:", e);
        }
      });

      $("btnAdd").addEventListener("click", async () => {
        const input = $("place");
        const place = (input.value || "").trim();
        if (!place) return;

        const fileInput = $("imageFile");
        const file = fileInput?.files?.[0] || null;

        try {
          $("formStatus").textContent = "Guardando marcador e imagen...";
          await addPlace(place, file);
          input.value = "";
          if (fileInput) fileInput.value = ""; // limpia el input
          await refreshMarkers();
          $("formStatus").textContent = "Marcador añadido.";
        } catch (e) {
          console.error(e);
          $("formStatus").textContent = "No se pudo añadir.";
        }
      });


      onAuthStateChanged(auth, renderUser);
    });
  </script>
</head>

<body>
  <header>
    <div class="user">
      <img id="userAvatar" alt="avatar" />
      <div>
        <div id="userName">No autenticado</div>
        <div id="status"></div>
      </div>
    </div>

    <button id="btnLogin">Entrar con Google</button>
    <button id="btnLogout">Salir</button>
  </header>

  <main>
    <h1>Mapa</h1>

    <div class="panel">
      <input id="place" placeholder="Añade país o ciudad (ej: Japón, Madrid, Kyoto...)" />
      <button id="btnAdd">Añadir marcador</button>
      <div class="hint">(Necesitas estar logueado para guardar y ver tus marcadores)</div>
      <div id="formStatus" class="hint"></div>
      <input id="imageFile" type="file" accept="image/*" />
    </div>

    <div id="map"></div>
    <div id="gallery" style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;"></div>
  </main>
</body>
</html>
